## 报文结构

**字节序 (Byte Order):** Big-Endian (Network Byte Order)

```Plaintext
0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  MessageType  |                 RequestID                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| (ReqID cont.) |   Operation   |            Body ...           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
|                                                               |
|                       Body (Variable Length)                  |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

## 头部字段定义

头部总长度：**6 Bytes**


| Offset | Length   | Field Name      | Type     | Description                                  |
| ------ | -------- | --------------- | -------- | -------------------------------------------- |
| **0**  | 1 Byte   | **MessageType** | `uint8`  | 消息的类别（请求、响应等）                   |
| **1**  | 4 Bytes  | **RequestID**   | `uint32` | 请求的唯一标识符（大端序）用于匹配请求与响应 |
| **5**  | 1 Byte   | **Operation**   | `uint8`  | 具体业务操作指令（如存款、取款）             |
| **6**  | Variable | **Body**        | `[]byte` | 业务负载数据。具体格式取决于`Operation`      |

## 数据类型编码

### String

由 **4字节长度前缀** 和 **UTF-8 字节流** 组成

```plaintext
+-------------------+-----------------------------------------+
| Length (uint32)   | Raw Bytes (UTF-8) ...                   |
+-------------------+-----------------------------------------+
| 4 Bytes           | N Bytes (where N = Length)              |
+-------------------+-----------------------------------------+
```

### Float64

```plaintext
+-------------------------------------------------------------+
| IEEE 754 Float64 (uint64 bits)                              |
+-------------------------------------------------------------+
| 8 Bytes                                                     |
+-------------------------------------------------------------+
```

### Uint32

```plaintext
+---------------------------+
| Unsigned Int 32           |
+---------------------------+
| 4 Bytes                   |
+---------------------------+
```

## 常量映射表

Message Types (Offset: 0)


| **Value** | **Enum Name** | **Description**     |
| --------- | ------------- | ------------------- |
| `0x00`    | `MsgRequest`  | 发起请求            |
| `0x01`    | `MsgReply`    | 正常响应            |
| `0x02`    | `MsgError`    | 错误响应            |
| `0x03`    | `MsgCallback` | 服务器主动推送/回调 |

Operations (Offset: 5)


| **Value** | **Enum Name**     | **Idempotent** | **Description** |
| --------- | ----------------- | -------------- | --------------- |
| `0x01`    | `OpOpen`          | No             | 开户            |
| `0x02`    | `OpClose`         | No             | 销户            |
| `0x03`    | `OpDeposit`       | No             | 存款            |
| `0x04`    | `OpWithdraw`      | No             | 取款            |
| `0x05`    | `OpMonitor`       | -              | 开启监控        |
| `0x06`    | `OpCheckBalance`  | **Yes**        | 查询余额        |
| `0x07`    | `OpApplyInterest` | No             | 结算利息        |

Currencies (Used in Body)


| **Value** | **Enum Name** |
| --------- | ------------- |
| `0x00`    | `CurrencyUSD` |
| `0x01`    | `CurrencySGD` |
| `0x02`    | `CurrencyEUR` |

## 业务负载结构

### Open Account

* **关联操作**: `OpOpen (1)`
* **对应结构**: `OpenAccountRequest`
* request

```plaintext
+---------------------------------------------------------------+
|                        Name Length (UINT32)                   |
+---------------------------------------------------------------+
|                        Name Bytes (Variable)                  |
~                                                               ~
+---------------------------------------------------------------+
|                      Password Length (UINT32)                 |
+---------------------------------------------------------------+
|                      Password Bytes (Variable)                |
~                                                               ~
+---------------+-----------------------------------------------+
| Currency (U8) |                                               |
+---------------+                                               |
|                      Balance (FLOAT64)                        |
|                                                               |
+---------------------------------------------------------------+
```

currency + balance 是9byte，现在是没有对齐的（想用go来写，不存在内存映射问题）

* reply

  ```0
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |  MsgType (1)  |           RequestID (Top 24 bits)             |
  |     0x01      |             0x00      0x00      0x00          |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  | ReqID (Low 8) |   OpOpen (1)  |     AccountID (Top 16 bits)   |
  |     0x65      |     0x01      |       0x12      0x34          |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |  AccountID (Low 16 bits)      |
  |     0x56      0x78            |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  ```

### Auth Action

* **关联操作**: `OpClose (2)`, `OpCheckBalance (6)`, `OpApplyInterest (7)`
* **对应结构**: `AuthRequest`
* request

```plaintext
+---------------------------------------------------------------+
|                        Name Length (UINT32)                   |
+---------------------------------------------------------------+
|                        Name Bytes (Variable)                  |
~                                                               ~
+---------------------------------------------------------------+
|                      Password Length (UINT32)                 |
+---------------------------------------------------------------+
|                      Password Bytes (Variable)                |
~                                                               ~
+---------------------------------------------------------------+
|                       AccountID (UINT32)                      |
+---------------------------------------------------------------+
```

* reply
  **OpClose**

  ```0
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |                      String Length (31)                       |
  |     0x00      0x00      0x00      0x1F                        |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |   'A' (0x41)  |   'c' (0x63)  |   'c' (0x63)  |   'o' (0x6F)  |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |   'u' (0x75)  |   'n' (0x6E)  |   't' (0x74)  |   ' ' (0x20)  |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |   '1' (0x31)  |   '0' (0x30)  |   '0' (0x30)  |   ' ' (0x20)  |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |   'c' (0x63)  |   'l' (0x6C)  |   'o' (0x6F)  |   's' (0x73)  |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |                  ... (剩余的 "ed successfully") ...           |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  ```

  **OpCheckBalance**

### Transaction

* **关联操作**: `OpDeposit (3)`, `OpWithdraw (4)`
* **对应结构**: `TransactionRequest`
* request

```plaintext
+---------------------------------------------------------------+
|                        Name Length (UINT32)                   |
+---------------------------------------------------------------+
|                        Name Bytes (Variable)                  |
~                                                               ~
+---------------------------------------------------------------+
|                      Password Length (UINT32)                 |
+---------------------------------------------------------------+
|                      Password Bytes (Variable)                |
~                                                               ~
+---------------------------------------------------------------+
|                       AccountID (UINT32)                      |
+---------------------------------------------------------------+
|                                                               |
+                      Amount (FLOAT64)                         +
|                                                               |
+---------------------------------------------------------------+
```

* response
  **OpDeposit**

  ```
  0                   1                   2                   3
   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |                                                               |
  +                   New Balance (FLOAT64)                       +
  |                                                               |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  ```

  **OpWithdraw**

  和OpDeposit一样

### Monitor

* **关联操作**: `OpMonitor (5)`
* **对应结构**: `MonitorRequest`
* 执行流程

  1. **Client**: 发送 `OpMonitor` 请求（带上时间 N 秒）。
  2. **Server (`RegisterMonitor`)**:

     * 计算 `Expiry = Now + N`。
     * 把 Client 加入 `monitors` 列表。
     * **立即返回** "Subscribed" 消息。
  3. **Client**: 收到 "Subscribed"，知道监控生效了。
  4. **Server (稍后)**:

     * 发生存款/取款。
     * 遍历 `monitors` 列表。
     * 发现该 Client `Now < Expiry`。
     * 发送 `MsgCallback` 通知余额变化。
* 报文交互举例

request 假设请求30s

```plaintext
0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  MsgType (0)  |           RequestID (Top 24 bits)             |
|     0x00      |             0x00      0x00      0x00          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| ReqID (Low 8) | OpMonitor (5) |      Duration (Top 16 bits)   |
|     0x69      |     0x05      |       0x00      0x00          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Duration (Low 16 bits)      |
|     0x00      0x1E            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

response

```plaintext
0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  MsgType (1)  |           RequestID (Top 24 bits)             |
|     0x01      |             0x00      0x00      0x00          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| ReqID (Low 8) | OpMonitor (5) |    String Length (Top 16)     |
|     0x69      |     0x05      |       0x00      0x00          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    String Length (Low 16)     |   'S' (0x53)  |   'u' (0x75)  |
|     0x00      0x19            |               |               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   'b' (0x62)  |   's' (0x73)  |   'c' (0x63)  |   'r' (0x72)  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   'i' (0x69)  |   'b' (0x62)  |   'e' (0x65)  |   'd' (0x64)  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   ' ' (0x20)  |   'f' (0x66)  |   'o' (0x6F)  |   'r' (0x72)  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   ' ' (0x20)  |   '3' (0x33)  |   '0' (0x30)  |   ' ' (0x20)  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   's' (0x73)  |   'e' (0x65)  |   'c' (0x63)  |   'o' (0x6F)  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   'n' (0x6E)  |   'd' (0x64)  |   's' (0x73)  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```
